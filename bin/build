#!/usr/bin/env node

// I tried building a concatenation step in Grunt, but it ended up being more complex than just writing it myself
var fs = require('fs');
var path = require('path');
// var cleanCSS = require('clean-css');
// var UglifyJS = require('uglify-js');

var plugins = {
    arduino: ['arduino', 'control', 'input' ],//boolean', , 'digitalio', 'math', 'serialio', 'timing', 'variables'.'input'],
    javascript: ['javascript', 'asset', 'control', 'sprite', 'voice', 'array', 'boolean', 'canvas', 'color',  'image', 'math', 'object', 'string', 'path', 'point', 'rect', 'sensing', 'shape', 'size', /*'social',*/ /*'fb'*/, 'text', 'matrix' /*'demo'*/],
    minecraftjs: ['minecraftjs', 'control', 'game', 'player', 'position', 'blocks',  'camera', 'array', 'boolean', 'math', 'string'],
    demo: ['javascript', 'demo']
};

var styles = {
    arduino: ['stylesheets/workspace.css', 'stylesheets/blocks.css', 'stylesheets/fonts/fontawesome.css', 'lib/highlight-github.css', 'stylesheets/menu.css'],
    javascript: ['stylesheets/workspace.css', 'stylesheets/blocks.css', 'lib/highlight-github.css', 'stylesheets/menu.css', 'stylesheets/fonts/fontawesome.css'],
    minecraftjs: ['stylesheets/workspace.css', 'stylesheets/blocks.css', 'lib/highlight-github.css', 'stylesheets/fonts/fontawesome.css'],
    demo: ['stylesheets/workspace.css', 'stylesheets/blocks.css', 'lib/highlight-github.css', 'stylesheets/fonts/fontawesome.css']
}

var scripts = ['ajax', 'queryparams', 'util', 'event', 'drag', 'uuid', 'block', 'ui', 'workspace', 'blockprefs'];

var libs = {
    arduino: [],
    javascript: ['beautify', 'highlight', 'highlight-javascript'],
    minecraftjs: ['beautify', 'highlight', 'highlight-javascript'],
    demo: ['beautify', 'highlight', 'highlight-javascript']
};


function clear(){
    if (fs.existsSync('dist')){
        var files = fs.readdirSync('dist');
        files.forEach(function(filename){
            fs.unlinkSync(path.join('dist', filename));
        });
    }else{
        fs.mkdirSync('dist');
    }
};


function cat(src, dest){
    fs.appendFileSync(dest, '\n/*begin ' + path.basename(src).replace(/\\/g, '/') + '*/\n');
    fs.appendFileSync(dest, fs.readFileSync(src, 'utf8'));
    fs.appendFileSync(dest, '\n/*end ' + path.basename(src).replace(/\\/g, '/') + '*/\n');
}

function endswith(str, suffix){
    return RegExp(suffix + '$').test(str);
}

function concat(src, dest, files, ext, suffix, before, after){
    before = before || '';
    after = after || '';
    suffix = suffix || '';
    files.forEach(function(pathname){
        var filename = path.join(src, pathname) + suffix + ext;
        try{
            var contents = before + fs.readFileSync(path.join(filename), 'utf8') + after;
        }catch(e){
            // console.log('file %s not found', path.join(filename));
            // console.log('Could not read %s: %s', path.join(filename), e.message);
            return;
        }
        fs.appendFileSync(dest, '\n/*begin ' + filename.replace(/\\/g, '/') + '*/\n');
        fs.appendFileSync(dest, contents);
        fs.appendFileSync(dest, '\n/*end ' + filename.replace(/\\/g, '/') + '*/\n');
    });
}

function build(){
    clear();
    Object.keys(plugins).forEach(function(lang){
        var files = plugins[lang];
        var src = path.join('languages', lang);
        var dest = path.join('dist', lang);
        libs[lang].forEach(function(libname){cat('lib/' + libname + '.js', dest + '.js'); });
        styles[lang].forEach(function(stylename){cat(stylename, dest + '.css'); });
        scripts.forEach(function(scriptname){cat('scripts/' + scriptname + '.js', dest + '.js'); });
        // Build CSS
        concat(src, dest + '.css', files, '.css');
        // Build Waterbear support
        concat(src, dest + '.js', files, '.js');
        // Build Waterbear blocks
        concat(src, dest + '.js', files, '.json', null, 'wb.menu(', ');');
        // Build runtime support
        if (lang === 'javascript' || lang === 'minecraftjs'){
            concat(src, dest + '_runtime.js', files, '.js', '_runtime');
        }
    });
};

build();
